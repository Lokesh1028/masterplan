import { NextResponse } from "next/server"
import { prisma } from "@/lib/prisma"
import { getUserId } from "@/lib/session"
export async function GET(req: Request) { const uid = await getUserId(); if(!uid) return NextResponse.json({error:"Unauthorized"},{status:401}); const id = new URL(req.url).searchParams.get("id"); if(id){const inv = await prisma.invoice.findUnique({where:{id},include:{customer:true,items:true}}); if(!inv||inv.userId!==uid) return NextResponse.json({error:"Not found"},{status:404}); return NextResponse.json(inv)}; return NextResponse.json(await prisma.invoice.findMany({where:{userId:uid},include:{customer:{select:{name:true,phone:true}}},orderBy:{createdAt:"desc"}})) }
export async function POST(req: Request) { const uid = await getUserId(); if(!uid) return NextResponse.json({error:"Unauthorized"},{status:401}); const d = await req.json(); for(const item of d.items){const p = await prisma.product.findUnique({where:{id:item.productId}}); if(!p) return NextResponse.json({error:`Product not found: ${item.productName}`},{status:400}); if(p.stockQuantity<item.qty) return NextResponse.json({error:`Insufficient stock for ${p.name}: only ${p.stockQuantity} available`},{status:400})}; const count = await prisma.invoice.count({where:{userId:uid}}); const invoiceNumber = "INV-"+String(count+1).padStart(4,"0"); const invoice = await prisma.invoice.create({data:{userId:uid,customerId:d.customerId||null,invoiceNumber,subtotal:d.subtotal,taxRate:d.taxRate,taxAmount:d.taxAmount,discountPercentage:d.discountPercentage||0,discountAmount:d.discountAmount||0,totalAmount:d.totalAmount,status:"COMPLETED",notes:d.notes||"",items:{create:d.items.map((i:any)=>({productId:i.productId,productName:i.productName,qty:i.qty,priceAtSale:i.priceAtSale,costAtSale:i.costAtSale,subtotal:i.subtotal}))}},include:{items:true}}); for(const item of d.items) await prisma.product.update({where:{id:item.productId},data:{stockQuantity:{decrement:item.qty}}}); const custName = d.customerId?(await prisma.customer.findUnique({where:{id:d.customerId}}))?.name:"Customer"; await prisma.transaction.create({data:{userId:uid,type:"EXPORT",amount:d.totalAmount,description:`Invoice ${invoiceNumber} - ${custName}`,referenceId:invoice.id}}); return NextResponse.json(invoice) }
